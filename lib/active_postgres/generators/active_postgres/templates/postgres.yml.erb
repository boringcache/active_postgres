# PostgreSQL High Availability Configuration
# Generated by active_postgres
#
# ðŸ’¡ Either:
#   1. Edit this file manually with your database servers
#   2. Use Terraform to auto-generate this file
#
# See: config/postgres.example.yml in gem for full examples

shared: &shared
  version: 18
  user: ubuntu
  ssh_key: ~/.ssh/id_rsa

  components:
    core:
      locale: en_US.UTF-8
      encoding: UTF8
      # Optional: Override default PostgreSQL user and app database config
      # postgres_user: postgres
      # app_user: app
      # app_database: app_production
      postgresql:
        listen_addresses: '*'
        port: 5432
        max_connections: 100
        shared_buffers: 256MB

    repmgr:
      enabled: false
      # Optional: Override default repmgr user/database
      # user: repmgr
      # database: repmgr

    pgbouncer:
      enabled: false
      # Optional: Override default pgbouncer user
      # user: pgbouncer
    
    pgbackrest:
      enabled: false
    
    monitoring:
      enabled: false
    
    ssl:
      enabled: false

development:
  <<: *shared
  primary:
    host: localhost
    port: 5432

production:
  <<: *shared

  # TODO: Configure your primary database server
  # host: Public IP for SSH deployment (like Kamal)
  # private_ip: Private/VPC IP for database connections (optional, falls back to host)
  primary:
    host: YOUR_PRIMARY_PUBLIC_IP
    private_ip: YOUR_PRIMARY_PRIVATE_IP
    label: us-east-1

  # TODO: Add standby servers for HA (optional)
  # standby:
  #   - host: YOUR_STANDBY_PUBLIC_IP
  #     private_ip: YOUR_STANDBY_PRIVATE_IP
  #     label: us-west-2
  
  # Enable components as needed
  components:
    repmgr:
      enabled: false  # Enable for HA with standbys
  
  # Secrets: Using Rails credentials (update via: rails credentials:edit)
  # The $(command) syntax allows executing commands to fetch secrets
  secrets:
    superuser_password: $(rails runner "puts Rails.application.credentials.dig(:postgres, :superuser_password)")
    replication_password: $(rails runner "puts Rails.application.credentials.dig(:postgres, :replication_password)")
    repmgr_password: $(rails runner "puts Rails.application.credentials.dig(:postgres, :repmgr_password)")
    pgbouncer_password: $(rails runner "puts Rails.application.credentials.dig(:postgres, :password)")
    app_password: $(rails runner "puts Rails.application.credentials.dig(:postgres, :password)")

