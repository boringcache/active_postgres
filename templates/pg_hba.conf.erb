# PostgreSQL Client Authentication Configuration File
# Generated by active_postgres
<%
  core_config = config.component_config(:core)
  pg_hba_rules = core_config[:pg_hba] || []

  # Detect network from primary private_ip
  detected_network = if config.primary && config.primary['private_ip']
    ip_parts = config.primary['private_ip'].split('.')
    "#{ip_parts[0]}.#{ip_parts[1]}.0.0/16"
  else
    '10.8.0.0/16' # Default to common VPN/private network
  end

  # Default rules if none specified
  if pg_hba_rules.empty?
    pg_hba_rules = [
      {type: 'local', database: 'all', user: 'all', method: 'peer'},
      {type: 'host', database: 'all', user: 'all', address: '127.0.0.1/32', method: 'scram-sha-256'},
      {type: 'host', database: 'all', user: 'all', address: detected_network, method: 'scram-sha-256'}
    ]
  end
%>

# TYPE  DATABASE        USER            ADDRESS                 METHOD

<% pg_hba_rules.each do |rule| %>
<% if rule[:type] == 'local' %>
<%= rule[:type] %>   <%= rule[:database] %>             <%= rule[:user] %>                                     <%= rule[:method] %>
<% else %>
<%= rule[:type] %>    <%= rule[:database] %>             <%= rule[:user] %>             <%= rule[:address] %>            <%= rule[:method] %>
<% end %>
<% end %>

<% if config.component_enabled?(:repmgr) && !pg_hba_rules.any? { |r| r[:database] == 'replication' } %>
# Replication connections (auto-added for repmgr)
<%
  # Find the network rule (not 127.0.0.1) for replication, or fall back to 10.8.0.0/24
  repmgr_network = pg_hba_rules.find { |r| r[:type] == 'host' && r[:address] && !r[:address].start_with?('127.0.0.1') }&.dig(:address) || '10.8.0.0/24'
  repmgr_user = config.repmgr_user
  repmgr_db = config.repmgr_database
%>
host    replication     <%= repmgr_user %>          <%= repmgr_network %>          scram-sha-256
host    <%= repmgr_db %>          <%= repmgr_user %>          <%= repmgr_network %>          scram-sha-256
<% end %>


