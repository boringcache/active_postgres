# PostgreSQL configuration file
# Generated by active_postgres
<%
  # pg_config is now provided by the Core component
  # It contains either user config OR auto-tuned + user config (merged)
  core_config = config.component_config(:core)
%>

# Cluster Settings
data_directory = '/var/lib/postgresql/<%= config.version %>/main'
hba_file = '/etc/postgresql/<%= config.version %>/main/pg_hba.conf'
ident_file = '/etc/postgresql/<%= config.version %>/main/pg_ident.conf'
external_pid_file = '/var/run/postgresql/<%= config.version %>-main.pid'
cluster_name = '<%= config.version %>-main'

# Connection Settings
listen_addresses = '<%= pg_config[:listen_addresses] || '*' %>'
port = <%= pg_config[:port] || 5432 %>
max_connections = <%= pg_config[:max_connections] || 100 %>
unix_socket_directories = '/var/run/postgresql'

# Memory Settings
shared_buffers = <%= pg_config[:shared_buffers] || '256MB' %>
effective_cache_size = <%= pg_config[:effective_cache_size] || '1GB' %>
work_mem = <%= pg_config[:work_mem] || '4MB' %>
maintenance_work_mem = <%= pg_config[:maintenance_work_mem] || '64MB' %>
<% if pg_config[:wal_buffers] %>
wal_buffers = <%= pg_config[:wal_buffers] %>
<% end %>
<% if pg_config[:huge_pages] %>
huge_pages = <%= pg_config[:huge_pages] %>
<% end %>

# WAL Settings (for replication)
wal_level = <%= pg_config[:wal_level] || 'replica' %>
max_wal_senders = <%= pg_config[:max_wal_senders] || 10 %>
max_replication_slots = <%= pg_config[:max_replication_slots] || 10 %>
wal_keep_size = <%= pg_config[:wal_keep_size] || '1GB' %>
<% if pg_config[:hot_standby] %>
hot_standby = <%= pg_config[:hot_standby] %>
<% end %>
<% if pg_config[:wal_compression] %>
wal_compression = <%= pg_config[:wal_compression] %>
<% end %>
<% if pg_config[:archive_mode] %>
archive_mode = <%= pg_config[:archive_mode] %>
<% end %>
<% if pg_config[:archive_command] %>
archive_command = '<%= pg_config[:archive_command] %>'
<% end %>
<% if pg_config[:shared_memory_type] %>
shared_memory_type = <%= pg_config[:shared_memory_type] %>
<% end %>
<% if pg_config[:wal_init_zero] %>
wal_init_zero = <%= pg_config[:wal_init_zero] %>
<% end %>
<% if pg_config[:wal_recycle] %>
wal_recycle = <%= pg_config[:wal_recycle] %>
<% end %>

# Checkpoint Settings
checkpoint_completion_target = <%= pg_config[:checkpoint_completion_target] || 0.9 %>
checkpoint_timeout = <%= pg_config[:checkpoint_timeout] || '15min' %>

# Query Planner Settings
<% if pg_config[:default_statistics_target] %>
default_statistics_target = <%= pg_config[:default_statistics_target] %>
<% end %>
<% if pg_config[:random_page_cost] %>
random_page_cost = <%= pg_config[:random_page_cost] %>
<% end %>
<% if pg_config[:effective_io_concurrency] %>
effective_io_concurrency = <%= pg_config[:effective_io_concurrency] %>
<% end %>

# Parallel Query Settings
<% if pg_config[:max_worker_processes] %>
max_worker_processes = <%= pg_config[:max_worker_processes] %>
<% end %>
<% if pg_config[:max_parallel_workers_per_gather] %>
max_parallel_workers_per_gather = <%= pg_config[:max_parallel_workers_per_gather] %>
<% end %>
<% if pg_config[:max_parallel_workers] %>
max_parallel_workers = <%= pg_config[:max_parallel_workers] %>
<% end %>
<% if pg_config[:max_parallel_maintenance_workers] %>
max_parallel_maintenance_workers = <%= pg_config[:max_parallel_maintenance_workers] %>
<% end %>

# Logging
logging_collector = <%= pg_config[:logging_collector] || 'on' %>
log_directory = '<%= pg_config[:log_directory] || 'log' %>'
log_filename = '<%= pg_config[:log_filename] || 'postgresql-%Y-%m-%d_%H%M%S.log' %>'
log_rotation_age = <%= pg_config[:log_rotation_age] || '1d' %>
log_rotation_size = <%= pg_config[:log_rotation_size] || '100MB' %>
log_line_prefix = '%t [%p]: [%l-1] user=%u,db=%d,app=%a,client=%h '
log_timezone = 'UTC'
<% if pg_config[:log_checkpoints] %>
log_checkpoints = <%= pg_config[:log_checkpoints] %>
<% end %>
<% if pg_config[:log_connections] %>
log_connections = <%= pg_config[:log_connections] %>
<% end %>
<% if pg_config[:log_disconnections] %>
log_disconnections = <%= pg_config[:log_disconnections] %>
<% end %>
<% if pg_config[:log_lock_waits] %>
log_lock_waits = <%= pg_config[:log_lock_waits] %>
<% end %>
<% if pg_config[:log_temp_files] %>
log_temp_files = <%= pg_config[:log_temp_files] %>
<% end %>
<% if pg_config[:log_autovacuum_min_duration] %>
log_autovacuum_min_duration = <%= pg_config[:log_autovacuum_min_duration] %>
<% end %>
<% if pg_config[:log_min_duration_statement] %>
log_min_duration_statement = <%= pg_config[:log_min_duration_statement] %>
<% end %>

# Locale
datestyle = 'iso, mdy'
timezone = 'UTC'
lc_messages = '<%= core_config[:locale] || 'en_US.UTF-8' %>'
lc_monetary = '<%= core_config[:locale] || 'en_US.UTF-8' %>'
lc_numeric = '<%= core_config[:locale] || 'en_US.UTF-8' %>'
lc_time = '<%= core_config[:locale] || 'en_US.UTF-8' %>'
default_text_search_config = 'pg_catalog.english'

<% if config.component_enabled?(:ssl) %>
# SSL Configuration
ssl = on
ssl_cert_file = '/etc/postgresql/<%= config.version %>/main/server.crt'
ssl_key_file = '/etc/postgresql/<%= config.version %>/main/server.key'
<% end %>

# JIT Compilation
<% if pg_config[:jit] %>
jit = <%= pg_config[:jit] %>
<% end %>

# Additional settings
shared_preload_libraries = '<%= pg_config[:shared_preload_libraries] || 'pg_stat_statements' %>'
<% if pg_config[:'pg_stat_statements.max'] %>
pg_stat_statements.max = <%= pg_config[:'pg_stat_statements.max'] %>
<% end %>
<% if pg_config[:'pg_stat_statements.track'] %>
pg_stat_statements.track = <%= pg_config[:'pg_stat_statements.track'] %>
<% end %>

<% if pg_config[:custom] %>
# Custom configuration
<% pg_config[:custom].each do |key, value| %>
<%= key %> = <%= value %>
<% end %>
<% end %>


